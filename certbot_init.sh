#!/bin/bash

# Установите ваш реальный email и домен здесь
EMAIL="ligioner29@mail.ru"
DOMAIN="lek29.ru"
DOMAIN_WWW="www.lek29.ru"

# --------------------------------------------------------
# 1. Очистка и остановка всех старых контейнеров
# --------------------------------------------------------
echo "Остановка и удаление предыдущих контейнеров и сетей..."
# Убедитесь, что здесь используется только один compose-файл:
docker compose -f docker-compose.yaml down --volumes --remove-orphans

# --------------------------------------------------------
# 2. Проверка существования каталогов Certbot
# --------------------------------------------------------
# Certbot и Nginx должны монтировать эти папки
mkdir -p ./certbot/www
mkdir -p ./certbot/conf

# --------------------------------------------------------
# 3. Запуск только Nginx в фоне с init-конфигом
# --------------------------------------------------------
echo "Запуск Nginx для прохождения проверки Certbot..."
# Используем docker-compose.yaml (ваш главный файл)
# Предполагаем, что в нем Nginx настроен на прослушивание 80 порта
# и использует `nginx.conf` с location /.well-known/...
docker compose -f docker-compose.yaml up -d nginx

# --------------------------------------------------------
# 4. Гарантированное ожидание и проверка статуса контейнера
# --------------------------------------------------------
echo "Пауза 10 секунд для инициализации Nginx..."
sleep 10

NGINX_STATUS=$(docker compose -f docker-compose.yaml ps -q nginx | xargs docker inspect -f '{{.State.Status}}')

if [ "$NGINX_STATUS" != "running" ]; then
    echo -e "\n--------------------------------------------------------"
    echo -e "⛔ КРИТИЧЕСКАЯ ОШИБКА NGINX ⛔"
    echo "Nginx не смог запуститься. Проверьте логи: 'docker compose logs nginx'"
    echo "Ожидаемый статус 'running', текущий статус: '$NGINX_STATUS'."
    echo -e "--------------------------------------------------------"
    exit 1
fi

echo "Nginx готов. (Статус $NGINX_STATUS)"

# --------------------------------------------------------
# 5. Запуск Certbot для получения сертификатов
# --------------------------------------------------------
echo "Nginx готов. Запускаем Certbot..."
# Используем --force-renewal, чтобы обновить тестовый сертификат на боевой
docker compose -f docker-compose.yaml run --rm certbot \
    certonly --webroot \
    -w /var/www/certbot \
    --force-renewal \
    --email "$EMAIL" \
    -d "$DOMAIN" -d "$DOMAIN_WWW" \
    --rsa-key-size 4096 \
    --agree-tos \
    --noninteractive || {
        echo -e "\n--------------------------------------------------------"
        echo -e "⛔ КРИТИЧЕСКАЯ ОШИБКА CERTBOT ⛔"
        echo -e "Certbot не смог получить сертификат. Контейнеры Nginx оставлены запущенными."
        echo -e "--------------------------------------------------------"
        exit 1
    }

# --------------------------------------------------------
# 6. Финальный запуск продакшен-среды с новым сертификатом
# --------------------------------------------------------

# ВАЖНО: Мы переключаемся с init-конфига Nginx на продакшен-конфиг.
# Для этого мы должны изменить монтирование конфига Nginx в docker-compose.yaml
# (Это исправление было сделано ранее в другом файле, поэтому здесь мы просто запускаем)

if [ -f "./certbot/conf/live/$DOMAIN/fullchain.pem" ]; then
    echo "Сертификаты успешно получены. Остановка init-контейнеров..."

    # ОСТАНОВКА ТОЛЬКО NGINX
    docker compose -f docker-compose.yaml stop nginx
    docker compose -f docker-compose.yaml rm -f nginx

    echo "Запуск ВСЕЙ продакшен-среды с новым сертификатом..."

    # Теперь запускаем ВСЕ сервисы. (Предполагается, что в docker-compose.yaml
    # Nginx использует правильный prod-конфиг и монтирует сертификаты.)
    docker compose -f docker-compose.yaml up -d --build

    echo -e "\n--------------------------------------------------------"
    echo -e "✅ УСПЕХ! СЕРТИФИКАТЫ ПОЛУЧЕНЫ И ВСЕ СЕРВИСЫ ЗАПУЩЕНЫ."
    echo "Ваш сайт должен быть доступен по адресу https://$DOMAIN"
    echo -e "--------------------------------------------------------"
else
    # ЭТОТ БЛОК ТЕПЕРЬ ПОЧТИ НЕВОЗМОЖЕН БЛАГОДАРЯ --force-renewal
    echo -e "\n--------------------------------------------------------"
    echo "Certbot прошел (exit 0), но файлы сертификатов не найдены. Это аномалия."
    echo "Проверьте логи Certbot и Nginx. Остановка всех сервисов."
    echo -e "--------------------------------------------------------"
    docker compose -f docker-compose.yaml down
    exit 1
fi
