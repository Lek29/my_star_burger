#!/bin/bash

# Установите ваш реальный email и домен здесь
EMAIL="your_email@example.com" # !!! ОБЯЗАТЕЛЬНО ЗАМЕНИТЬ !!!
DOMAIN="lek29.ru"
DOMAIN_WWW="www.lek29.ru"

# --------------------------------------------------------
# 1. Очистка и остановка всех старых контейнеров
# --------------------------------------------------------
echo "Остановка и удаление предыдущих контейнеров и сетей..."
docker compose -f docker-compose.prod.yaml down --volumes --remove-orphans

# --------------------------------------------------------
# 2. Проверка существования каталогов Certbot
# --------------------------------------------------------
# Certbot и Nginx должны монтировать эти папки
mkdir -p ./certbot/www
mkdir -p ./certbot/conf

# --------------------------------------------------------
# 3. Запуск только Nginx в фоне с init-конфигом
# --------------------------------------------------------
echo "Запуск Nginx для прохождения проверки Certbot..."
docker compose -f docker-compose.prod.yaml up -d nginx

# --------------------------------------------------------
# 4. Гарантированная пауза
# --------------------------------------------------------
# Даем Nginx время на полную инициализацию порта 80
echo "Пауза 5 секунд для полной инициализации Nginx..."
sleep 5

# --------------------------------------------------------
# 5. Запуск Certbot для получения сертификатов
# --------------------------------------------------------
echo "Nginx готов. Запускаем Certbot..."
docker compose -f docker-compose.prod.yaml run --rm certbot \
    certonly --webroot \
    -w /var/www/certbot \
    --force-renewal \
    --email "$EMAIL" \
    -d "$DOMAIN" -d "$DOMAIN_WWW" \
    --rsa-key-size 4096 \
    --agree-tos \
    --noninteractive || {
        echo -e "\n--------------------------------------------------------"
        echo -e "⛔ КРИТИЧЕСКАЯ ОШИБКА CERTBOT ⛔"
        echo -e "Certbot не смог получить сертификат. Проверьте логи Nginx и настройки DNS."
        echo -e "--------------------------------------------------------"
        docker compose -f docker-compose.prod.yaml down
        exit 1
    }

# --------------------------------------------------------
# 6. Обновление конфигурации Nginx и Перезапуск
# --------------------------------------------------------
if [ -f "./certbot/conf/live/$DOMAIN/fullchain.pem" ]; then
    echo "Сертификаты успешно получены. Переключение Nginx на продакшен-конфиг..."

    # Копируем prod-конфиг на место init-конфига для Nginx
    # ! Здесь предполагается, что вы замените init.conf на prod.conf !

    # Для целей этого скрипта, мы просто перезапускаем все контейнеры
    # Используем 'down' и 'up' для гарантии, что все сервисы стартуют с новой конфигурацией
    echo "Остановка сервисов..."
    docker compose -f docker-compose.prod.yaml down

    echo "Запуск продакшен-среды с новым сертификатом..."
    docker compose -f docker-compose.prod.yaml up -d --build

    echo -e "\n--------------------------------------------------------"
    echo -e "✅ УСПЕХ! СЕРТИФИКАТЫ ПОЛУЧЕНЫ И ВСЕ СЕРВИСЫ ЗАПУЩЕНЫ."
    echo -e "--------------------------------------------------------"
else
    echo "Certbot прошел, но файлы сертификатов не найдены."
    docker compose -f docker-compose.prod.yaml down
    exit 1
fi
