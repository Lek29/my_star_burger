#!/bin/bash
# deploy_site.sh: Скрипт для сборки и запуска основного сайта (без SSL).
# Использует docker-compose.prod.yaml

set -euo pipefail # Строгий режим: завершение при любой ошибке

# --- НАСТРОЙКИ ---
DOMAIN="lek29.ru"
DOCKER_COMPOSE_FILE="docker-compose.prod.yaml"

# Функция для вызова Docker Compose V2
compose() {
    # Обратите внимание: в вашем проекте сервис называется 'backend', но
    # команда 'compose exec' и 'wait' требует имени сервиса из YAML.
    # Если в YAML сервис называется 'backend', будем использовать 'backend'.
    sudo docker compose --file "$DOCKER_COMPOSE_FILE" "$@"
}

# --------------------------------------------------------
# 0. Подготовка и Очистка
# --------------------------------------------------------
echo "--- 0. ПОДГОТОВКА: Очистка старых контейнеров и обновление кода ---"
# Остановка системного Nginx (если он запущен) для освобождения порта 80
echo "   > ОСВОБОЖДАЕМ ПОРТ 80: Остановка системного Nginx (игнорируем ошибку, если его нет)..."
# Мы останавливаем и отключаем системный Nginx, чтобы гарантировать, что он не мешает
sudo systemctl stop nginx || true
sudo systemctl disable nginx || true

# Остановка и удаление ВСЕХ старых контейнеров проекта
compose down --volumes --remove-orphans

# Получение свежего кода
echo "   > Обновление кода из Git..."
git pull

# --------------------------------------------------------
# 1. Сборка Docker-образов
# --------------------------------------------------------
echo "--- 1. СБОРКА: Создание новых Docker-образов (Backend, Frontend) ---"
compose build

# --------------------------------------------------------
# 2. Запуск Продакшен-среды (без Certbot, Nginx работает на HTTP)
# --------------------------------------------------------
echo "--- 2. ЗАПУСК: Подъем всех продакшен-сервисов (db, backend, nginx) ---"
# Мы поднимаем все сервисы, включая Nginx.
compose up -d --remove-orphans

# --------------------------------------------------------
# 3. Сборка фронтенда (Parcel) - Роль: Программист (Архитектор)
# --------------------------------------------------------
echo "--- 3. ФРОНТЕНД: Сборка статических бандлов Parcel ---"
# Parcel должен выполняться в своем контейнере, который создается и завершается ('--rm')
compose run --rm frontend npx parcel build bundles-src/index.js --public-url /bundles/ --dist-dir dist --no-source-maps

# --------------------------------------------------------
# КЛЮЧЕВОЙ НОВЫЙ ЭТАП: Ожидание готовности Backend
# --------------------------------------------------------
echo "--- 4. ОЖИДАНИЕ: Ждем готовности контейнера 'backend' ---"
# Ждем, пока сервис 'backend' не будет готов. Docker Compose использует healthcheck db и
# зависитмость от frontend (уже отработал), чтобы определить готовность.
# Если сервис в YAML называется 'backend', мы ждем 'backend'.
compose wait backend

# --------------------------------------------------------
# 5. Выполнение миграций и сбор статики - Роль: Программист (Архитектор)
# --------------------------------------------------------
echo "--- 5. БЭКЕНД: Выполнение миграций БД и сбор статики Django ---"
# Теперь мы уверены, что контейнер запущен и готов к работе.
compose exec -T backend python manage.py migrate --noinput
# Копируем статические файлы
compose exec -T backend python manage.py collectstatic --noinput

# --------------------------------------------------------
# 6. Перезагрузка Nginx - Роль: DevOps-инженер
# --------------------------------------------------------
echo "--- 6. ПЕРЕЗАГРУЗКА NGINX: Применение новой статики и бандлов ---"
# Убиваем Nginx сигналом HUP, чтобы он перечитал конфигурацию и статику.
compose kill -s HUP nginx || true

echo -e "\n--------------------------------------------------------"
echo -e "✅ Установка сайта (Фаза 1) завершена!"
echo -e "Сайт должен быть доступен по адресу http://$DOMAIN"
echo -e "--------------------------------------------------------"
